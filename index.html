<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Cyber Casino - Member Access</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;500&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #020617; color: white; }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 4s ease-in-out infinite; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-btn:hover { box-shadow: 0 0 20px rgba(234, 179, 8, 0.5); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Cropper Styles Updated */
        .crop-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        .crop-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 4px solid #eab308;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); /* Darken outside area */
            z-index: 20;
            pointer-events: none; /* Let clicks pass through to drag area */
        }
        .drag-area {
            width: 100%;
            height: 100%;
            cursor: grab;
            overflow: hidden;
            position: relative;
            border-radius: 10px; /* Just container radius */
        }
        .drag-area:active { cursor: grabbing; }
        
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #eab308;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://burwdynmnxxefhoeyudv.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1cndkeW5tbnh4ZWZob2V5dWR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MzE2ODgsImV4cCI6MjA3OTMwNzY4OH0.zeL1Lp5nbyb5CXbhYQ_VtyR12-59CetzwngcrTclVY0';

        const localStore = {
            get: (key) => JSON.parse(localStorage.getItem(key) || 'null'),
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
        };

        class MockSupabaseClient {
            constructor() { console.warn("Mode Offline Aktif"); }
            get auth() {
                return {
                    signUp: async ({ email, options }) => ({ data: { user: { id: 'local_'+email, email, user_metadata: options?.data } }, error: null }),
                    signInWithPassword: async ({ email }) => ({ data: { user: { id: 'local_'+email, email } }, error: null }),
                    signOut: async () => ({ error: null }),
                    getSession: async () => ({ data: { session: null } }),
                    onAuthStateChange: (cb) => ({ data: { subscription: { unsubscribe: () => {} } } }),
                    updateUser: async (data) => ({ data: { user: { ...data } }, error: null })
                };
            }
            from() { return { select: () => ({ eq: () => ({ single: async () => ({ data: null, error: 'Offline' }) }) }), insert: async () => ({ error: 'Offline' }), update: async () => ({ error: 'Offline' }) }; }
        }

        let supabase;
        try { 
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true } }); 
        } catch (e) { supabase = new MockSupabaseClient(); }

        // --- ICONS ---
        const Icons = {
            Crown: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            CreditCard: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Message: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        };

        // --- IMAGE CROPPER COMPONENT (IMPROVED) ---
        function ImageCropper({ imageSrc, onCancel, onCrop }) {
            const [zoom, setZoom] = React.useState(1);
            const [minZoom, setMinZoom] = React.useState(0.1);
            const [position, setPosition] = React.useState({ x: 0, y: 0 });
            const [dragging, setDragging] = React.useState(false);
            const [lastPos, setLastPos] = React.useState({ x: 0, y: 0 });
            const imgRef = React.useRef(null);
            
            const CONTAINER_SIZE = 280; // Ukuran area crop

            // --- LOGIKA AUTO FIT (PENTING) ---
            React.useEffect(() => {
                const img = new Image();
                img.src = imageSrc;
                img.onload = () => {
                    // Hitung rasio agar gambar pas (Cover) di dalam lingkaran
                    const widthRatio = CONTAINER_SIZE / img.naturalWidth;
                    const heightRatio = CONTAINER_SIZE / img.naturalHeight;
                    
                    // Pilih rasio terbesar supaya gambar menutupi seluruh lingkaran (tidak ada ruang kosong)
                    const initialZoom = Math.max(widthRatio, heightRatio);
                    
                    setZoom(initialZoom);
                    setMinZoom(initialZoom * 0.5); // User boleh zoom out dikit
                };
            }, [imageSrc]);

            const handleMouseDown = (e) => {
                setDragging(true);
                setLastPos({ x: e.clientX, y: e.clientY });
            };

            const handleMouseMove = (e) => {
                if (!dragging) return;
                const dx = e.clientX - lastPos.x;
                const dy = e.clientY - lastPos.y;
                setPosition(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                setLastPos({ x: e.clientX, y: e.clientY });
            };

            const handleTouchStart = (e) => {
                setDragging(true);
                setLastPos({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };

            const handleTouchMove = (e) => {
                if (!dragging) return;
                const dx = e.touches[0].clientX - lastPos.x;
                const dy = e.touches[0].clientY - lastPos.y;
                setPosition(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                setLastPos({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };

            const handleMouseUp = () => setDragging(false);

            const handleSave = () => {
                const canvas = document.createElement('canvas');
                const size = 400; // Output resolusi tinggi
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // Background hitam jika ada bagian kosong
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, size, size);
                
                if(imgRef.current) {
                    const img = imgRef.current;
                    
                    // Hitung skala relatif antara container (280px) dan output canvas (400px)
                    const scaleFactor = size / CONTAINER_SIZE;
                    
                    const imgWidth = img.naturalWidth * zoom * scaleFactor;
                    const imgHeight = img.naturalHeight * zoom * scaleFactor;
                    
                    // Posisi tengah
                    const drawX = (size - imgWidth) / 2 + (position.x * scaleFactor);
                    const drawY = (size - imgHeight) / 2 + (position.y * scaleFactor);

                    // Crop Lingkaran
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(img, drawX, drawY, imgWidth, imgHeight);
                    ctx.restore();
                }

                onCrop(canvas.toDataURL('image/jpeg', 0.85));
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-slate-900 p-6 rounded-2xl w-full max-w-sm border border-white/10 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-4 text-center">Sesuaikan Foto</h3>
                        
                        <div className="flex justify-center mb-6 select-none">
                            <div className="crop-wrapper">
                                <div className="crop-container"></div> {/* Overlay Lingkaran */}
                                <div 
                                    className="drag-area"
                                    onMouseDown={handleMouseDown}
                                    onMouseMove={handleMouseMove}
                                    onMouseUp={handleMouseUp}
                                    onMouseLeave={handleMouseUp}
                                    onTouchStart={handleTouchStart}
                                    onTouchMove={handleTouchMove}
                                    onTouchEnd={handleMouseUp}
                                >
                                    <img 
                                        ref={imgRef}
                                        src={imageSrc} 
                                        alt="Crop" 
                                        className="absolute max-w-none pointer-events-none transition-transform duration-75"
                                        style={{
                                            transform: `translate(calc(-50% + ${position.x}px), calc(-50% + ${position.y}px)) scale(${zoom})`,
                                            left: '50%',
                                            top: '50%'
                                        }}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="mb-6 px-4">
                            <div className="flex justify-between text-xs text-slate-400 mb-2">
                                <span>Zoom Out</span>
                                <span>Zoom In</span>
                            </div>
                            <input 
                                type="range" 
                                min={minZoom} 
                                max={minZoom * 5} 
                                step={minZoom / 10} 
                                value={zoom} 
                                onChange={(e) => setZoom(parseFloat(e.target.value))}
                                className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb"
                            />
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl bg-slate-800 text-white hover:bg-slate-700 font-bold flex items-center justify-center gap-2 transition-colors">
                                <Icons.X /> Batal
                            </button>
                            <button onClick={handleSave} className="flex-1 py-3 rounded-xl bg-yellow-500 text-black hover:bg-yellow-400 font-bold flex items-center justify-center gap-2 transition-colors">
                                <Icons.Check /> Simpan
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- AUTH COMPONENT ---
        function AuthPage() {
            const [isRegister, setIsRegister] = React.useState(false);
            const [email, setEmail] = React.useState('');
            const [fullName, setFullName] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [errorMsg, setErrorMsg] = React.useState('');
            const [successMsg, setSuccessMsg] = React.useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true); setErrorMsg(''); setSuccessMsg('');
                const cleanEmail = email.trim();
                
                try {
                    let result;
                    if (isRegister) {
                        if (!fullName) throw new Error("Nama Lengkap wajib diisi!");
                        result = await supabase.auth.signUp({ 
                            email: cleanEmail, 
                            password,
                            options: { data: { full_name: fullName } } 
                        });
                    } else {
                        result = await supabase.auth.signInWithPassword({ email: cleanEmail, password });
                    }

                    if (result.error) throw result.error;
                    if (isRegister && result.data?.user && !result.data?.session) setSuccessMsg("Daftar Berhasil! Silakan Login.");
                } catch (error) {
                    let msg = error.message;
                    if (msg.includes("fetch")) {
                        localStorage.setItem('sb-session', JSON.stringify({ user: { id: 'local_'+cleanEmail, email: cleanEmail, user_metadata: { full_name: fullName || 'Guest' } } }));
                        window.location.reload();
                        return;
                    }
                    if (msg.includes("Invalid login")) msg = "Email/Password salah.";
                    setErrorMsg(msg);
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-[#020617] relative">
                    <div className="absolute inset-0 pointer-events-none"><div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-purple-900/20 to-blue-900/20"></div></div>
                    <div className="w-full max-w-md glass-panel p-8 rounded-2xl shadow-2xl relative z-10">
                        <div className="text-center mb-6"><h1 className="text-3xl font-bold text-yellow-500 font-cyber tracking-widest">ROYAL CYBER</h1></div>
                        <div className="flex border-b border-white/10 mb-6">
                            <button onClick={() => setIsRegister(false)} className={`flex-1 py-3 text-sm font-bold ${!isRegister ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-slate-500'}`}>MASUK</button>
                            <button onClick={() => setIsRegister(true)} className={`flex-1 py-3 text-sm font-bold ${isRegister ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-slate-500'}`}>DAFTAR</button>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            {errorMsg && <div className="bg-red-500/20 text-red-200 px-4 py-2 rounded text-sm">{errorMsg}</div>}
                            {successMsg && <div className="bg-green-500/20 text-green-200 px-4 py-2 rounded text-sm">{successMsg}</div>}
                            
                            {isRegister && (
                                <div className="relative group animate-fade-in">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icons.User /></div>
                                    <input type="text" required className="w-full bg-slate-800/50 border border-white/10 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-yellow-500" placeholder="Nama Lengkap (Display Name)" value={fullName} onChange={(e)=>setFullName(e.target.value)}/>
                                </div>
                            )}

                            <div className="relative group">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg></div>
                                <input type="email" required className="w-full bg-slate-800/50 border border-white/10 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-yellow-500" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)}/>
                            </div>
                            <div className="relative group">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icons.Lock /></div>
                                <input type="password" required className="w-full bg-slate-800/50 border border-white/10 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-yellow-500" placeholder="Password" value={password} onChange={(e)=>setPassword(e.target.value)}/>
                            </div>
                            <button type="submit" disabled={loading} className="w-full py-4 bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-bold rounded-xl font-cyber glow-btn mt-4">
                                {loading ? 'LOADING...' : (isRegister ? 'DAFTAR' : 'MASUK')}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- PROFILE COMPONENT WITH CROPPER ---
        function ProfilePage({ session, profileData, refreshProfile }) {
            const [email, setEmail] = React.useState(session.user.email);
            const [password, setPassword] = React.useState('');
            const [fullName, setFullName] = React.useState(profileData?.full_name || '');
            const [avatarUrl, setAvatarUrl] = React.useState(profileData?.avatar_url || '');
            const [msg, setMsg] = React.useState('');
            const [isCropping, setIsCropping] = React.useState(false);
            const [tempImgSrc, setTempImgSrc] = React.useState(null);
            const fileInputRef = React.useRef(null);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { 
                        alert("Ukuran gambar terlalu besar! Maksimal 5MB.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setTempImgSrc(reader.result);
                        setIsCropping(true); 
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = null;
            };

            const handleCropComplete = (croppedBase64) => {
                setAvatarUrl(croppedBase64);
                setIsCropping(false);
                setTempImgSrc(null);
            };

            const handleUpdate = async (e) => {
                e.preventDefault();
                setMsg('Mengupdate...');
                
                const authUpdates = { email };
                if (password) authUpdates.password = password;
                const { error: authError } = await supabase.auth.updateUser(authUpdates);

                const { error: dbError } = await supabase.from('players').update({
                    full_name: fullName,
                    avatar_url: avatarUrl
                }).eq('id', session.user.id);

                if (authError || dbError) setMsg("Gagal: " + (authError?.message || dbError?.message));
                else {
                    setMsg("Profile Berhasil Diupdate!");
                    refreshProfile();
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-6 animate-fade-in relative">
                    {isCropping && (
                        <ImageCropper 
                            imageSrc={tempImgSrc} 
                            onCancel={() => setIsCropping(false)} 
                            onCrop={handleCropComplete} 
                        />
                    )}

                    <h2 className="text-2xl font-cyber text-yellow-400 mb-6 border-b border-white/10 pb-4">Edit Profile</h2>
                    
                    <form onSubmit={handleUpdate} className="space-y-6">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-yellow-500 bg-slate-800 relative group cursor-pointer shadow-[0_0_30px_rgba(234,179,8,0.2)]" onClick={() => fileInputRef.current.click()}>
                                <img src={avatarUrl || `https://api.dicebear.com/9.x/dylan/svg?seed=${fullName}`} alt="Avatar" className="w-full h-full object-cover" />
                                <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Icons.Edit />
                                    <span className="text-xs font-bold mt-1 text-yellow-400">Ubah Foto</span>
                                </div>
                            </div>
                            <input type="file" ref={fileInputRef} onChange={handleImageChange} className="hidden" accept="image/*" />
                            <span className="text-xs text-slate-400">Maks 5MB (JPG/PNG)</span>
                        </div>

                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Nama Tampilan</label>
                            <input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 outline-none" placeholder="Nama Lengkap" />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Email</label>
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Password Baru (Kosongkan jika tidak ubah)</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 outline-none" placeholder="********" />
                        </div>
                        <button className="px-6 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded font-bold w-full shadow-lg">SIMPAN PERUBAHAN</button>
                        {msg && <p className="text-center text-yellow-400 mt-2">{msg}</p>}
                    </form>
                </div>
            );
        }

        function TopUpPage({ onTopUp }) {
            const amounts = [10000, 25000, 50000, 100000, 500000, 1000000];
            return (
                <div className="max-w-4xl mx-auto p-6">
                    <h2 className="text-2xl font-cyber text-yellow-400 mb-6 border-b border-white/10 pb-4">Isi Saldo (Top Up)</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {amounts.map(amt => (
                            <button key={amt} onClick={() => onTopUp(amt)} className="p-6 bg-slate-800 border border-slate-700 rounded-xl hover:border-yellow-500 hover:bg-slate-700 transition-all group">
                                <div className="text-slate-400 text-xs mb-1">Chip</div>
                                <div className="text-xl font-bold text-white group-hover:text-yellow-400">{amt.toLocaleString()}</div>
                            </button>
                        ))}
                    </div>
                    <p className="mt-8 text-slate-500 text-sm text-center">Klik nominal untuk langsung mengisi saldo (Simulasi).</p>
                </div>
            );
        }

        function InfoPage() {
            return (
                <div className="max-w-2xl mx-auto p-6">
                    <h2 className="text-2xl font-cyber text-yellow-400 mb-6 border-b border-white/10 pb-4">Tentang Aplikasi</h2>
                    <div className="space-y-4 text-slate-300 leading-relaxed">
                        <p>Selamat datang di <strong>Royal Cyber Casino</strong>, platform simulasi slot paling canggih dengan tema Cyberpunk.</p>
                        <p>Tujuan aplikasi ini adalah sebagai sarana hiburan semata ("Just for Fun") dan demonstrasi teknologi web modern. Tidak ada uang sungguhan yang digunakan dalam perjudian di sini. Semua chip adalah virtual.</p>
                        <p>Nikmati sensasi bermain tanpa risiko finansial!</p>
                    </div>
                </div>
            );
        }

        function PatternPage() {
            return (
                <div className="max-w-3xl mx-auto p-6">
                    <h2 className="text-2xl font-cyber text-yellow-400 mb-6 border-b border-white/10 pb-4">Informasi Pola Gacor (RTP)</h2>
                    <div className="grid gap-4">
                        <div className="bg-slate-800/50 p-4 rounded-lg border border-yellow-500/30">
                            <h3 className="text-lg font-bold text-yellow-400 mb-2">üî• Pola Pagi (06:00 - 10:00)</h3>
                            <p className="text-sm text-slate-300">Auto 20x | Manual 5x | Auto 10x</p>
                            <div className="w-full bg-slate-700 h-2 rounded mt-2"><div className="bg-green-500 h-2 rounded" style={{width: '85%'}}></div></div>
                            <span className="text-xs text-green-400">Win Rate 85%</span>
                        </div>
                        <div className="bg-slate-800/50 p-4 rounded-lg border border-blue-500/30">
                            <h3 className="text-lg font-bold text-blue-400 mb-2">üåô Pola Malam (20:00 - 00:00)</h3>
                            <p className="text-sm text-slate-300">Manual 10x | Auto 50x (Turbo Off)</p>
                            <div className="w-full bg-slate-700 h-2 rounded mt-2"><div className="bg-yellow-500 h-2 rounded" style={{width: '60%'}}></div></div>
                            <span className="text-xs text-yellow-400">Win Rate 60%</span>
                        </div>
                        <div className="p-4 bg-red-900/20 border border-red-500/20 rounded text-sm text-red-200">
                            ‚ö†Ô∏è Pola ini hanya prediksi simulasi dan tidak menjamin kemenangan 100%.
                        </div>
                    </div>
                </div>
            );
        }

        function FeedbackPage() {
            const [title, setTitle] = React.useState('');
            const [desc, setDesc] = React.useState('');
            const [isSent, setIsSent] = React.useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if(!title || !desc) return;
                setIsSent(true);
                setTimeout(() => {
                    setTitle(''); setDesc(''); setIsSent(false);
                    alert("Feedback Terkirim! Terima kasih atas masukan Anda.");
                }, 1000);
            };

            return (
                <div className="max-w-2xl mx-auto p-6">
                    <h2 className="text-2xl font-cyber text-yellow-400 mb-6 border-b border-white/10 pb-4">Kirim Feedback</h2>
                    <div className="bg-slate-800/50 p-6 rounded-xl border border-white/10">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Judul Laporan</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 outline-none" placeholder="Contoh: Bug pada tombol spin" />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Deskripsi Detail</label>
                                <textarea rows="4" value={desc} onChange={e => setDesc(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 outline-none" placeholder="Jelaskan masalah atau saran Anda..." />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Lampirkan Gambar (Opsional)</label>
                                <div className="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center hover:border-yellow-500/50 transition-colors cursor-pointer">
                                    <div className="flex flex-col items-center gap-2 text-slate-500">
                                        <Icons.Image /><span className="text-xs">Klik untuk upload screenshot</span>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" disabled={isSent} className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-lg transition-colors">{isSent ? 'MENGIRIM...' : 'KIRIM FEEDBACK'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        const SYMBOLS = [
            { id: 1, icon: "üíé", color: 'text-cyan-400', value: 50 },
            { id: 2, icon: "üëë", color: 'text-yellow-400', value: 30 },
            { id: 3, icon: "üîÆ", color: 'text-pink-500', value: 20 },
            { id: 4, icon: "üíµ", color: 'text-green-400', value: 10 },
            { id: 5, icon: "‚ú®", color: 'text-purple-400', value: 5 },
        ];

        function GameContent({ balance, updateBalance, winMessage, setWinMessage }) {
            const [reels, setReels] = React.useState([SYMBOLS[0], SYMBOLS[0], SYMBOLS[0]]);
            const [isSpinning, setIsSpinning] = React.useState(false);
            const [winAmount, setWinAmount] = React.useState(0);
            const [isAuto, setIsAuto] = React.useState(false);
            const autoRef = React.useRef(isAuto);

            React.useEffect(() => { autoRef.current = isAuto; }, [isAuto]);

            const spin = async () => {
                if (balance < 100) {
                    setIsAuto(false);
                    return setWinMessage("Saldo Habis!");
                }
                
                const newBal = balance - 100;
                updateBalance(newBal); 
                setIsSpinning(true); setWinAmount(0); setWinMessage(isAuto ? "Auto Spinning..." : "Spinning...");

                const interval = setInterval(() => setReels([
                    SYMBOLS[Math.floor(Math.random()*5)], SYMBOLS[Math.floor(Math.random()*5)], SYMBOLS[Math.floor(Math.random()*5)]
                ]), 100);

                await new Promise(r => setTimeout(r, 1000));
                clearInterval(interval);
                
                const final = [SYMBOLS[Math.floor(Math.random()*5)], SYMBOLS[Math.floor(Math.random()*5)], SYMBOLS[Math.floor(Math.random()*5)]];
                setReels(final);
                
                let win = 0; let msg = isAuto ? "Auto Mode On" : "Coba Lagi";
                if (final[0].id === final[1].id && final[1].id === final[2].id) { win = final[0].value * 20; msg = "JACKPOT!!!"; }
                else if (final[0].id === final[1].id || final[1].id === final[2].id || final[0].id === final[2].id) { win = 200; msg = "BIG WIN!"; }
                
                if (win > 0) { 
                    updateBalance(newBal + win); 
                    setWinAmount(win); 
                    if(isAuto) setWinMessage(`Win +${win}`);
                    else setWinMessage(msg);
                }

                setIsSpinning(false);

                if (autoRef.current && newBal >= 100) {
                    setTimeout(spin, 500);
                } else if (autoRef.current) {
                    setIsAuto(false);
                }
            };

            React.useEffect(() => { if (isAuto && !isSpinning) spin(); }, [isAuto]);

            return (
                <div className="flex flex-col items-center justify-center min-h-[60vh]">
                    <div className="w-full max-w-lg bg-gradient-to-b from-yellow-600 via-yellow-500 to-yellow-800 p-1 rounded-3xl shadow-[0_0_60px_rgba(234,179,8,0.3)]">
                        <div className="bg-slate-950 rounded-[20px] p-6 border-4 border-slate-900 relative overflow-hidden text-center">
                            <div className="flex justify-between gap-2 mb-6">
                                {reels.map((s, i) => (
                                    <div key={i} className="flex-1 h-32 bg-slate-900/80 rounded-xl border border-slate-800 flex items-center justify-center text-4xl shadow-[inset_0_0_20px_black]">
                                        <span className={`filter drop-shadow-xl ${isSpinning ? 'animate-pulse blur-[2px]' : ''}`}>{s.icon}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="h-12 mb-4 flex items-center justify-center">
                                {winAmount > 0 ? <div className="text-yellow-400 font-black text-3xl font-cyber animate-bounce">+{winAmount}</div> : <div className="text-slate-500 font-light tracking-widest">{winMessage}</div>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsAuto(!isAuto)} className={`flex-1 py-4 rounded-xl font-bold text-xl transition-all ${isAuto ? 'bg-red-600 text-white animate-pulse' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{isAuto ? 'STOP' : 'AUTO'}</button>
                                <button onClick={() => { if(!isAuto) spin(); }} disabled={isSpinning || isAuto} className={`flex-[2] py-4 rounded-xl font-black text-2xl tracking-[0.2em] font-cyber transition-all transform active:scale-95 ${isSpinning || isAuto ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg hover:brightness-110'}`}>SPIN</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN DASHBOARD LAYOUT ---
        function Dashboard({ session, onLogout }) {
            const [view, setView] = React.useState('game');
            const [balance, setBalance] = React.useState(0);
            const [winMessage, setWinMessage] = React.useState('Selamat Datang');
            const [profileData, setProfileData] = React.useState({ full_name: '', avatar_url: '' });
            
            // Load Data
            const loadUserData = async () => {
                const { user } = session;
                try {
                    const { data, error } = await supabase.from('players').select('*').eq('id', user.id).single();
                    
                    if (data) {
                        setBalance(data.balance);
                        setProfileData({ full_name: data.full_name || 'Member', avatar_url: data.avatar_url });
                    } else if (error && (error.code === 'PGRST116' || error.message.includes('JSON'))) { 
                        const initialName = user.user_metadata?.full_name || 'Member Royal';
                        const initialAvatar = `https://api.dicebear.com/9.x/dylan/svg?seed=${initialName}`;
                        
                        await supabase.from('players').insert([{ 
                            id: user.id, 
                            balance: 10000,
                            full_name: initialName,
                            avatar_url: initialAvatar
                        }]);
                        setBalance(10000);
                        setProfileData({ full_name: initialName, avatar_url: initialAvatar });
                    }
                } catch (err) { console.log("Error loading data", err); }
            };
            
            React.useEffect(() => { loadUserData(); }, [session]);

            const updateBalance = async (newBal) => {
                setBalance(newBal);
                await supabase.from('players').update({ balance: newBal }).eq('id', session.user.id);
            };

            const handleTopUp = (amount) => {
                const newBal = balance + amount;
                updateBalance(newBal);
                setWinMessage(`Top Up +${amount.toLocaleString()} Sukses!`);
                setView('game');
            };

            const NavItem = ({ id, icon: Icon, label }) => (
                <button onClick={() => setView(id)} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all mb-1 ${view === id ? 'bg-yellow-500 text-black font-bold' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                    <Icon /> <span>{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex bg-[#020617]">
                    {/* SIDEBAR */}
                    <aside className="w-64 bg-slate-900 border-r border-white/5 flex flex-col hidden md:flex">
                        <div className="p-6 border-b border-white/5">
                            <div className="flex items-center gap-2 text-yellow-500">
                                <Icons.Crown /> <span className="font-cyber font-bold text-xl tracking-widest">ROYAL</span>
                            </div>
                        </div>
                        
                        {/* PROFILE MINI SIDEBAR */}
                        <div className="p-4 border-b border-white/5 flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full overflow-hidden border border-yellow-500/50">
                                <img src={profileData.avatar_url || `https://api.dicebear.com/9.x/dylan/svg?seed=${profileData.full_name}`} alt="Avatar" className="w-full h-full object-cover"/>
                            </div>
                            <div className="overflow-hidden">
                                <div className="text-sm font-bold text-white truncate">{profileData.full_name || 'Guest'}</div>
                                <div className="text-[10px] text-slate-500 truncate">ID: {session.user.email.split('@')[0]}</div>
                            </div>
                        </div>

                        <nav className="flex-1 p-4 overflow-y-auto">
                            <NavItem id="game" icon={Icons.Home} label="Game Slot" />
                            <NavItem id="topup" icon={Icons.CreditCard} label="Top Up Saldo" />
                            <NavItem id="pola" icon={Icons.Zap} label="Informasi Pola" />
                            <NavItem id="info" icon={Icons.Info} label="Informasi App" />
                            <NavItem id="feedback" icon={Icons.Message} label="Feedback" />
                            <div className="my-4 border-t border-white/5"></div>
                            <NavItem id="profile" icon={Icons.Settings} label="Profile Saya" />
                        </nav>
                        <div className="p-4 border-t border-white/5">
                            <button onClick={onLogout} className="w-full flex items-center gap-3 p-3 rounded-lg text-red-400 hover:bg-red-900/20 transition-colors">
                                <Icons.LogOut /> <span>Keluar</span>
                            </button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        {/* HEADER MOBILE/DESKTOP */}
                        <header className="h-16 border-b border-white/5 bg-slate-900/50 backdrop-blur flex items-center justify-between px-4 md:px-8">
                            <div className="flex items-center gap-3 md:hidden">
                                <div className="w-8 h-8 rounded-full overflow-hidden border border-yellow-500">
                                    <img src={profileData.avatar_url} alt="Av" className="w-full h-full object-cover"/>
                                </div>
                                <div className="font-cyber text-yellow-500 font-bold">ROYAL</div>
                            </div>
                            
                            <div className="hidden md:block font-bold text-slate-500 text-sm">
                                Selamat Datang, <span className="text-white">{profileData.full_name}</span>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="bg-black/30 border border-yellow-500/30 px-4 py-1.5 rounded-full flex items-center gap-2">
                                    <span className="text-[10px] text-slate-400 uppercase">SALDO</span>
                                    <span className="text-yellow-400 font-mono font-bold">{balance.toLocaleString()}</span>
                                </div>
                            </div>
                        </header>

                        {/* CONTENT AREA */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {view === 'game' && <GameContent balance={balance} updateBalance={updateBalance} winMessage={winMessage} setWinMessage={setWinMessage} />}
                            {view === 'profile' && <ProfilePage session={session} profileData={profileData} refreshProfile={loadUserData} />}
                            {view === 'topup' && <TopUpPage onTopUp={handleTopUp} />}
                            {view === 'info' && <InfoPage />}
                            {view === 'pola' && <PatternPage />}
                            {view === 'feedback' && <FeedbackPage />}
                        </div>
                        
                        {/* MOBILE BOTTOM NAV */}
                        <div className="md:hidden bg-slate-900 border-t border-white/5 flex justify-around p-2">
                            <button onClick={() => setView('game')} className={`p-2 rounded ${view==='game'?'text-yellow-400':'text-slate-500'}`}><Icons.Home /></button>
                            <button onClick={() => setView('topup')} className={`p-2 rounded ${view==='topup'?'text-yellow-400':'text-slate-500'}`}><Icons.CreditCard /></button>
                            <button onClick={() => setView('feedback')} className={`p-2 rounded ${view==='feedback'?'text-yellow-400':'text-slate-500'}`}><Icons.Message /></button>
                            <button onClick={() => setView('profile')} className={`p-2 rounded ${view==='profile'?'text-yellow-400':'text-slate-500'}`}><Icons.Settings /></button>
                        </div>
                    </main>
                </div>
            );
        }

        // --- ROOT APP ---
        function App() {
            const [session, setSession] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const init = async () => {
                    const local = JSON.parse(localStorage.getItem('sb-session'));
                    if (local) setSession(local);
                    try {
                        const { data } = await supabase.auth.getSession();
                        if (data.session) setSession(data.session);
                    } catch(e) {}
                    setLoading(false);
                };
                init();

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if(session) localStorage.setItem('sb-session', JSON.stringify(session));
                    else localStorage.removeItem('sb-session');
                });
                return () => subscription.unsubscribe();
            }, []);

            if (loading) return <div className="min-h-screen bg-[#020617] flex items-center justify-center text-yellow-500 animate-pulse font-cyber tracking-widest">LOADING SYSTEM...</div>;
            
            return !session ? <AuthPage /> : <Dashboard session={session} onLogout={() => supabase.auth.signOut()} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>